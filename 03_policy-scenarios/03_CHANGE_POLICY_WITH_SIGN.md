# Change a Policy with Signature

## Goal:
- User can not update a policy deployed in an ACM Hub/Managed Clusters without a proper signature  attached.

## Prerequisite: 
- Policy collection is already cloned locally in signing host (already done in [prerequisite-setup](../prerequisite-setup/GIT_CLONE_POLICY_COLLECTION.md))
- Integrity Shield protection is enabled. (already done in [install-scenarios](../install-scenarios/DEPLOY_ISHIELD.md))
 
## Action Steps:

Complete the following five steps:

### 1. Go to the directory of your cloned policy collection Git repository in the signing host

   [Command]
   ```
   cd <SIGING HOST DIR>/policy-collection
   ```
   
### 2. Edit the policy file `community/SC-System-and-Communications-Protection/policy-ocp4-certs.yaml`
   
   In line 52, change `minimumDuration` from current value to different one (e.g. `600h`)

   Confirm your changes are saved in the file:
   
   [Command]
   ```
   cat community/SC-System-and-Communications-Protection/policy-ocp4-certs.yaml| grep minimumDuration | head -n 1
   ```
   [Result]
   ```
   600h
   ```
    
### 3. Run the following command to sign policy file
    
   [Command] 
   ```
   curl -s  https://raw.githubusercontent.com/open-cluster-management/integrity-shield/master/scripts/gpg-annotation-sign.sh | bash -s \
        signer@enterprise.com \
        community/SC-System-and-Communications-Protection/policy-ocp4-certs.yaml
   ```
### 4. Run the the following command 
 
   Confirm two annotations started with "integrityshield.io" are attached to community/CM-Configuration-Management/policy-integrity-shield.yaml
 
   [Command]
   ```
   cat community/SC-System-and-Communications-Protection/policy-ocp4-certs.yaml | grep 'integrityshield.io/' | wc -l
   ```
   [Result]
   ```
   3
   ```
    
### 5. Commit your changes in policy-ocp4-certs.yaml to your cloned policy-collection git repository.

   [Command]
   ```
   git add community/SC-System-and-Communications-Protection/policy-ocp4-certs.yaml
   git commit -m 'policy-ocp4-certs.yaml with signature'
   git push origin master
   ```
   
   [Result]
   
   ```
    [master 52551a8] policy-ocp4-certs.yaml with signature
    1 file changed, 124 insertions(+), 116 deletions(-)
    rewrite community/SC-System-and-Communications-Protection/policy-ocp4-certs.yaml (75%)
    ...
    93fa995..52551a8  master -> master
   ```   
   
## Expected Result:

Continue to check the expected results after a minute (Above changes in Git repository will be synced by ACM Hub Cluster to update the changes in policy.)
    
[WebConsle-HUB]

1. Connect to ACM Hub Cluster WebConsole and go to polices page.
2. Search for `policy-integrity-shield-events`  in Find Policies and click  `policy-integrity-shield-events`  policy. 
3. Check if  policy-integrity-shield-events  is in compliant state (Cluster violation -> green) as show below.
     
  ![Policy Violation](../images/policy-integrity-shield-status-compliant.PNG)
    
4. If the policy `policy-integrity-shield-events` is in violation state (Cluster violation -> red)
    follow the `step 5` to delete previous violation events from  ACM Managed cluster.
    check if the policy `policy-integrity-shield-events`  is in compliant state in ACM Hub WebConsole, once the previous violation events are removed.
   
[OC-MANAGED]

5. Check Integrity Shield violation events in via OC commands in the ACM Managed Cluster.

   Run the following command to see the violation events generated by Integrity Shield.
   
   [Command]
   ```
   oc get events --all-namespaces  --field-selector type=IntegrityShield
   ```
   
   [Result]
   
   Confirm there is no event listed with the message that include `Result: deny`
   
  ![Block Events](../images/ishield-log.PNG)

   Run the following command to delete violation events generated by Integrity Shield.
   
   [Command] 
   ```
   oc get events --all-namespaces -o json --field-selector type=IntegrityShield | jq '.items[]' | jq -r '.metadata.name+" -n "+.metadata.namespace' | xargs kubectl delete events

   ```
